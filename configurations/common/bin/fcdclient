#!/usr/bin/env perl

use strict;
use warnings;
use utf8;
use IO::Socket::UNIX;
use Cwd qw(cwd);

my $dir;
if(@ARGV){
    $dir = join '|', @ARGV;
}else{
    $dir = $ENV{'HOME'};
}

my $wd = cwd();
my $user = getpwuid($<);
my $socket_path = "/tmp/fcd_$user.sock";

my $socket; 
my $fcdserver_started = 0;

while(1){
    $socket = IO::Socket::UNIX->new(
        Type => SOCK_STREAM(),
        Peer => $socket_path,
    );
    if($socket){
        last;
    }else{
        `fcdserver` unless $fcdserver_started;
        $fcdserver_started = 1;
    }
}

binmode(STDOUT, ":encoding(UTF-8)");
binmode($socket, ":encoding(UTF-8)");

$socket->autoflush(1);
print $socket "$wd|$dir\n";
chomp(my $line = <$socket>);
close $socket;
print $line;
